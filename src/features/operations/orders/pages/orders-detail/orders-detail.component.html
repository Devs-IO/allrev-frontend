<div
  class="container-fluid p-3 p-md-4"
  style="max-width: 1400px"
  *ngIf="order; else loadingTpl"
>
  <div class="d-flex align-items-center justify-content-between mb-4">
    <div class="d-flex align-items-center gap-3">
      <a
        routerLink="/orders"
        class="btn btn-outline-secondary btn-sm rounded-circle"
        style="
          width: 32px;
          height: 32px;
          padding: 0;
          display: grid;
          place-items: center;
        "
      >
        <i class="bi bi-arrow-left"></i>
      </a>
      <div>
        <h4 class="mb-0 fw-bold text-primary">
          Ordem #{{ order.orderNumber }}
        </h4>
        <div class="text-muted small">
          Contrato: {{ order.contractDate | date : "dd/MM/yyyy" }} • Cliente:
          <strong>{{ order.client.name }}</strong>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-12 col-md-4">
      <div
        class="card border-0 shadow-sm p-3 h-100 border-start border-4 border-primary"
      >
        <div class="text-muted small text-uppercase fw-bold mb-1">
          Valor Total (Cliente)
        </div>
        <div class="fs-4 fw-bold text-dark">
          {{ formatMoney(order.amountTotal) }}
        </div>
        <div class="small text-muted">Receita bruta da venda</div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div
        class="card border-0 shadow-sm p-3 h-100 border-start border-4 border-danger"
      >
        <div class="text-muted small text-uppercase fw-bold mb-1">
          Custo Total (Revisores)
        </div>
        <div class="fs-4 fw-bold text-danger">{{ formatMoney(totalCost) }}</div>
        <div class="small text-muted">Total a pagar aos assistentes</div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div
        class="card border-0 shadow-sm p-3 h-100 border-start border-4 border-success bg-success-subtle"
      >
        <div class="text-success small text-uppercase fw-bold mb-1">
          Lucro Líquido (Real)
        </div>
        <div class="fs-4 fw-bold text-success">
          {{ formatMoney(netProfit) }}
        </div>
        <div class="small text-success">
          Margem de {{ profitMargin | number : "1.0-1" }}%
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-12 col-xl-8">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-bottom-0 pt-4 pb-2">
          <h5 class="card-title fw-bold m-0">
            <i class="bi bi-list-check me-2 text-primary"></i>Detalhamento dos
            Serviços
          </h5>
        </div>
        <div class="table-responsive">
          <table
            class="table table-hover align-middle mb-0"
            style="font-size: 0.9rem"
          >
            <thead class="table-light">
              <tr>
                <th class="ps-3">Serviço</th>
                <th>Responsável</th>
                <th>Financeiro (Item)</th>
                <th>Prazo</th>
                <th>Status</th>
                <th class="text-end pe-3">Ações</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of order.items">
                <td class="ps-3">
                  <span class="fw-semibold d-block">{{
                    item.functionality.name
                  }}</span>
                </td>

                <td>
                  <div
                    class="d-flex align-items-center"
                    *ngIf="item.responsible; else noResp"
                  >
                    <div
                      class="avatar-sm bg-light text-secondary rounded-circle me-2 fw-bold small d-flex align-items-center justify-content-center border"
                      style="width: 28px; height: 28px"
                    >
                      {{ item.responsible.name?.charAt(0) || "U" }}
                    </div>
                    <span>{{ item.responsible.name }}</span>
                  </div>
                  <ng-template #noResp
                    ><span class="text-muted fst-italic small"
                      >--</span
                    ></ng-template
                  >
                </td>

                <td>
                  <div class="d-flex flex-column" style="font-size: 0.85em">
                    <span class="text-success" title="Valor cobrado do cliente">
                      <i class="bi bi-arrow-up-short"></i>
                      {{ formatMoney(item.price) }}
                    </span>
                    <span class="text-danger" title="Valor pago ao revisor">
                      <i class="bi bi-arrow-down-short"></i>
                      {{ formatMoney(item.responsible?.amount || 0) }}
                    </span>
                    <span
                      class="fw-bold border-top mt-1 pt-1"
                      title="Lucro neste item"
                    >
                      =
                      {{
                        formatMoney(
                          item.price - (item.responsible?.amount || 0)
                        )
                      }}
                    </span>
                  </div>
                </td>

                <td>
                  <span
                    [class.text-danger]="
                      item.itemStatus !== 'FINISHED' &&
                      isOverdue(item.clientDeadline)
                    "
                  >
                    {{ item.clientDeadline | date : "dd/MM" }}
                  </span>
                </td>

                <td>
                  <span
                    class="badge border"
                    [ngClass]="getStatusBadgeClass(item.itemStatus)"
                  >
                    {{ item.itemStatus }}
                  </span>
                </td>

                <td class="text-end pe-3 position-relative">
                  <button
                    class="btn btn-sm btn-outline-secondary d-inline-flex align-items-center gap-1"
                    (click)="toggleDropdown($event, item.id)"
                  >
                    <span
                      *ngIf="loadingItems[item.id]"
                      class="spinner-border spinner-border-sm"
                    ></span>
                    <span>Ações</span>
                    <i class="bi bi-chevron-down small"></i>
                  </button>

                  <div
                    class="dropdown-menu show shadow border-0"
                    *ngIf="openDropdownId === item.id"
                    style="
                      position: absolute;
                      right: 10px;
                      top: 100%;
                      z-index: 1000;
                      display: block;
                    "
                  >
                    <h6 class="dropdown-header bg-light py-2">
                      Mudar Status para:
                    </h6>
                    <button
                      class="dropdown-item"
                      (click)="changeItemStatus(item, 'IN_PROGRESS')"
                    >
                      <i class="bi bi-play text-primary me-2"></i>Em Andamento
                    </button>
                    <button
                      class="dropdown-item"
                      (click)="changeItemStatus(item, 'AWAITING_CLIENT')"
                    >
                      <i class="bi bi-person text-warning me-2"></i>Aguard.
                      Cliente
                    </button>
                    <button
                      class="dropdown-item"
                      (click)="changeItemStatus(item, 'AWAITING_ADVISOR')"
                    >
                      <i class="bi bi-eyeglasses text-info me-2"></i>Aguard.
                      Revisor
                    </button>
                    <div class="dropdown-divider"></div>
                    <button
                      class="dropdown-item fw-bold text-success"
                      (click)="changeItemStatus(item, 'FINISHED')"
                    >
                      <i class="bi bi-check-circle-fill me-2"></i>Finalizar
                    </button>
                    <button
                      class="dropdown-item text-danger"
                      (click)="changeItemStatus(item, 'CANCELED')"
                    >
                      <i class="bi bi-x-circle me-2"></i>Cancelar
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-12 col-xl-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-bottom-0 pt-4 pb-2">
          <h5 class="card-title fw-bold m-0">
            <i class="bi bi-wallet2 me-2 text-success"></i>Recebimentos
          </h5>
          <div class="d-flex justify-content-between mt-2 small">
            <span class="text-muted"
              >Pago:
              <b class="text-success">{{
                formatMoney(order.amountPaid)
              }}</b></span
            >
            <span class="text-muted"
              >Falta:
              <b class="text-danger">{{
                formatMoney(order.amountTotal - order.amountPaid)
              }}</b></span
            >
          </div>
          <div class="progress mt-2" style="height: 6px">
            <div
              class="progress-bar bg-success"
              [style.width.%]="(order.amountPaid / order.amountTotal) * 100"
            ></div>
          </div>
        </div>

        <div class="table-responsive">
          <table
            class="table table-sm align-middle mb-0"
            style="font-size: 0.85rem"
          >
            <thead class="table-light">
              <tr>
                <th class="ps-3">Venc.</th>
                <th>Valor</th>
                <th class="text-end pe-3">Baixa</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let inst of order.installments">
                <td
                  class="ps-3"
                  [class.text-decoration-line-through]="inst.paidAt"
                >
                  {{ inst.dueDate | date : "dd/MM" }}
                </td>
                <td class="fw-semibold">{{ formatMoney(inst.amount) }}</td>
                <td class="text-end pe-3">
                  <ng-container *ngIf="inst.paidAt; else payButton">
                    <span
                      class="badge bg-success-subtle text-success border border-success"
                      >PAGO {{ inst.paidAt | date : "dd/MM" }}</span
                    >
                  </ng-container>
                  <ng-template #payButton>
                    <button
                      class="btn btn-sm btn-success py-0 px-2 shadow-sm"
                      (click)="payInstallment(inst)"
                      [disabled]="loadingItems[inst.id]"
                    >
                      <i
                        *ngIf="!loadingItems[inst.id]"
                        class="bi bi-cash-coin me-1"
                      ></i>
                      <span
                        *ngIf="loadingItems[inst.id]"
                        class="spinner-border spinner-border-sm"
                      ></span>
                      Receber
                    </button>
                  </ng-template>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #loadingTpl>
  <div class="d-flex justify-content-center py-5">
    <div class="spinner-border text-primary"></div>
  </div>
</ng-template>

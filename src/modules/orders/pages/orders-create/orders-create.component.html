<div class="orders-create container my-4">
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5><i class="bi bi-clipboard-plus"></i> Nova Ordem de Serviço</h5>
      <div class="d-flex gap-2">
        <button
          type="button"
          class="btn btn-outline-secondary"
          (click)="resetForm()"
        >
          <i class="bi bi-arrow-counterclockwise"></i> Limpar
        </button>
        <button
          type="button"
          class="btn btn-primary"
          [disabled]="form.invalid"
          (click)="onSubmit()"
        >
          <i class="bi bi-save"></i> Salvar
        </button>
      </div>
    </div>
    <div class="card-body">
      <form [formGroup]="form" (ngSubmit)="onSubmit()">
        <div class="card mb-4">
          <div class="card-header">
            <h5><i class="bi bi-person"></i> Informações do Cliente</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-12 col-md-4">
                <label class="form-label"
                  ><i class="bi bi-person"></i> Cliente
                  <span class="req">*</span></label
                >
                <select
                  class="form-control"
                  formControlName="clientId"
                  [class.is-invalid]="invalid('clientId')"
                >
                  <option [ngValue]="null" disabled>Selecione…</option>
                  <option *ngFor="let c of clients$ | async" [value]="c.id">
                    {{ c.name }}
                  </option>
                </select>
                <div
                  *ngIf="invalid('clientId')"
                  class="invalid-feedback d-block"
                >
                  Cliente é obrigatório.
                </div>
              </div>

              <div class="col-12 col-md-4">
                <label class="form-label"
                  ><i class="bi bi-calendar2-event"></i> Concessão (contrato)
                  <span class="req">*</span></label
                >
                <input
                  type="date"
                  class="form-control"
                  formControlName="contractDate"
                  [class.is-invalid]="invalid('contractDate')"
                />
                <div class="form-text">
                  <small>Data em que o serviço foi contratado.</small>
                </div>
              </div>

              <div class="col-12 col-md-4">
                <label class="form-label"
                  ><i class="bi bi-wallet2"></i> Forma de pagamento
                  <span class="req">*</span></label
                >
                <select
                  class="form-control"
                  formControlName="paymentMethod"
                  [class.is-invalid]="invalid('paymentMethod')"
                >
                  <option [ngValue]="null" disabled>Selecione…</option>
                  <option *ngFor="let m of paymentMethods" [value]="m.value">
                    {{ m.label }}
                  </option>
                </select>
                <div
                  *ngIf="invalid('paymentMethod')"
                  class="invalid-feedback d-block"
                >
                  Forma de pagamento é obrigatória.
                </div>
              </div>

              <div class="col-12 col-md-4">
                <label class="form-label"
                  ><i class="bi bi-card-checklist"></i> Parcelamento</label
                >
                <select class="form-control" formControlName="paymentTerms">
                  <option [value]="'ONE'">1x</option>
                  <option [value]="'TWO'">2x</option>
                  <option [value]="'THREE'">3x</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="card mb-4 mt-3">
          <div
            class="card-header d-flex justify-content-between align-items-center"
          >
            <h5><i class="bi bi-list-task"></i> Serviços Contratados</h5>
            <button
              type="button"
              class="btn btn-sm btn-outline-primary"
              (click)="addItem()"
              [disabled]="form.invalid"
            >
              <i class="bi bi-plus"></i> Adicionar Serviço
            </button>
          </div>
          <div class="card-body">
            <div formArrayName="items">
              <div
                class="service-item border rounded p-3 mb-3"
                *ngFor="let item of items.controls; let i = index"
                [formGroupName]="i"
              >
                <div class="row g-3">
                  <div class="col-12 col-md-6">
                    <label class="form-label"
                      ><i class="bi bi-gear"></i> Serviço
                      <span class="req">*</span></label
                    >
                    <select
                      class="form-control"
                      formControlName="functionalityId"
                      (change)="onFunctionalityChange(i, $event)"
                      [class.is-invalid]="itemInvalid(i, 'functionalityId')"
                    >
                      <option [ngValue]="null" disabled>Selecione…</option>
                      <option
                        *ngFor="let f of functionalities$ | async"
                        [value]="f.id"
                      >
                        {{ f.name }}
                      </option>
                    </select>
                  </div>

                  <div class="col-12 col-md-3">
                    <label class="form-label"
                      ><i class="bi bi-currency-dollar"></i> Preço (Cliente)
                      <span class="req">*</span></label
                    >
                    <input
                      type="number"
                      class="form-control"
                      formControlName="price"
                      [class.is-invalid]="itemInvalid(i, 'price')"
                    />
                  </div>

                  <div class="col-12 col-md-3">
                    <label class="form-label"
                      ><i class="bi bi-calendar-check"></i> Prazo (Cliente)
                      <span class="req">*</span></label
                    >
                    <input
                      type="date"
                      class="form-control"
                      formControlName="clientDeadline"
                      [class.is-invalid]="itemInvalid(i, 'clientDeadline')"
                    />
                  </div>

                  <div class="col-12 col-md-4">
                    <label class="form-label"
                      ><i class="bi bi-person-check"></i> Responsável</label
                    >
                    <select
                      class="form-control"
                      formControlName="responsibleUserId"
                    >
                      <option [ngValue]="null">Ninguém (Padrão)</option>
                      <option
                        *ngFor="let user of users$ | async"
                        [value]="user.id"
                      >
                        {{ user.name }}
                      </option>
                    </select>
                  </div>

                  <div class="col-12 col-md-2">
                    <label class="form-label"
                      ><i class="bi bi-cash"></i> Valor (Assist.)</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      formControlName="assistantAmount"
                    />
                  </div>

                  <div class="col-12 col-md-3">
                    <label class="form-label"
                      ><i class="bi bi-calendar-minus"></i> Prazo
                      (Assist.)</label
                    >
                    <input
                      type="date"
                      class="form-control"
                      formControlName="assistantDeadline"
                    />
                  </div>

                  <div class="col-12 col-md-3 d-flex align-items-end">
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-danger w-100"
                      (click)="removeItem(i)"
                      aria-label="Remover este serviço"
                    >
                      <i class="bi bi-trash"></i> Remover
                    </button>
                  </div>
                </div>
              </div>

              <div
                *ngIf="items.controls.length === 0"
                class="text-center text-muted p-3"
              >
                Nenhum serviço adicionado. Clique em "Adicionar Serviço" para
                começar.
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-4">
          <button
            type="button"
            class="btn btn-lg btn-outline-secondary"
            (click)="resetForm()"
          >
            Limpar Formulário
          </button>
          <button
            type="submit"
            class="btn btn-lg btn-primary"
            [disabled]="form.invalid"
          >
            Salvar Ordem de Serviço
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

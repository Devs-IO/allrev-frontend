<div class="orders-create container my-4">
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5><i class="bi bi-clipboard-plus"></i> Nova Ordem de Serviço</h5>
      <div class="d-flex gap-2">
        <button
          type="button"
          class="btn btn-outline-secondary"
          (click)="resetForm()"
        >
          <i class="bi bi-arrow-counterclockwise"></i> Limpar
        </button>
        <button
          type="button"
          class="btn btn-primary"
          [disabled]="orderForm.invalid"
          (click)="onSubmit()"
        >
          <i class="bi bi-save"></i> Salvar
        </button>
      </div>
    </div>
    <div class="card-body">
      <form [formGroup]="orderForm" (ngSubmit)="onSubmit()">
        <div class="card mb-4">
          <div class="card-header">
            <h5><i class="bi bi-person"></i> Informações do Cliente</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-12 col-md-8">
                <label class="form-label"
                  ><i class="bi bi-person"></i> Cliente
                  <span class="req">*</span></label
                >
                <select
                  class="form-control"
                  formControlName="clientId"
                  [class.is-invalid]="invalid('clientId')"
                >
                  <option [ngValue]="null" disabled>Selecione o cliente</option>
                  <option
                    *ngFor="let client of clients$ | async"
                    [value]="client.id"
                  >
                    {{ client.name }}
                  </option>
                </select>
                <div class="invalid-feedback" *ngIf="invalid('clientId')">
                  Cliente é obrigatório.
                </div>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label"
                  ><i class="bi bi-calendar-check"></i> Concessão
                  <span class="req">*</span></label
                >
                <input
                  type="date"
                  class="form-control"
                  formControlName="contractDate"
                  [class.is-invalid]="invalid('contractDate')"
                />
              </div>
            </div>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-header">
            <h5><i class="bi bi-tools"></i> Detalhes do Serviço</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label"
                  ><i class="bi bi-gear-wide-connected"></i> Serviço
                  <span class="req">*</span></label
                >
                <select
                  class="form-control"
                  formControlName="functionalityId"
                  [class.is-invalid]="invalid('functionalityId')"
                  (change)="onServiceSelected($any($event.target).value)"
                >
                  <option [ngValue]="null" disabled>Selecione o serviço</option>
                  <option
                    *ngFor="let func of functionalities$ | async"
                    [value]="func.id"
                  >
                    {{ func.name }}
                  </option>
                </select>
                <div
                  class="invalid-feedback"
                  *ngIf="invalid('functionalityId')"
                >
                  Serviço é obrigatório.
                </div>
              </div>

              <div class="col-12 col-md-3">
                <label class="form-label"
                  ><i class="bi bi-calendar-x"></i> Prazo (Cliente)
                  <span class="req">*</span></label
                >
                <input
                  type="date"
                  class="form-control"
                  formControlName="clientDeadline"
                  [class.is-invalid]="invalid('clientDeadline')"
                />
              </div>
              <div class="col-12 col-md-3">
                <label class="form-label"
                  ><i class="bi bi-calendar3-week"></i> Prazo (Assist.)</label
                >
                <input
                  type="date"
                  class="form-control"
                  formControlName="assistantDeadline"
                />
              </div>
              <div class="col-12 col-md-12">
                <label class="form-label"
                  ><i class="bi bi-card-text"></i> Detalhes / Observações
                  <span class="req">*</span></label
                >
                <textarea
                  class="form-control"
                  formControlName="description"
                  rows="3"
                  placeholder="Ex: TCC da Bianca - Formatação ABNT, correção ortográfica..."
                  [class.is-invalid]="invalid('description')"
                ></textarea>
                <div class="invalid-feedback" *ngIf="invalid('description')">
                  Detalhes são obrigatórios.
                </div>
              </div>
              <div class="col-12 col-md-12">
                <label class="form-label"
                  ><i class="bi bi-person-check"></i> Responsável (Assist.)
                </label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="responsibleName"
                />
                <div class="invalid-feedback" *ngIf="invalid('responsibleId')">
                  Responsável é obrigatório.
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-header">
            <h5><i class="bi bi-cash-coin"></i> Financeiro</h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-12 col-md-3">
                <label class="form-label"
                  ><i class="bi bi-currency-dollar"></i> Preço (Cliente)
                  <span class="req">*</span></label
                >
                <input
                  type="number"
                  class="form-control"
                  formControlName="clientPrice"
                  [class.is-invalid]="invalid('clientPrice')"
                />
              </div>

              <div class="col-12 col-md-3">
                <label class="form-label"
                  ><i class="bi bi-wallet2"></i> Valor (Assist.)</label
                >
                <input
                  type="number"
                  class="form-control"
                  formControlName="assistantPrice"
                />
              </div>

              <div class="col-12 col-md-3">
                <label class="form-label"
                  ><i class="bi bi-credit-card"></i> Método Pag.
                  <span class="req">*</span></label
                >
                <select
                  class="form-control"
                  formControlName="paymentMethod"
                  [class.is-invalid]="invalid('paymentMethod')"
                >
                  <option *ngFor="let m of paymentMethods" [ngValue]="m">
                    {{ m }}
                  </option>
                </select>
              </div>

              <div class="col-12 col-md-3">
                <label class="form-label"
                  ><i class="bi bi-calendar-month"></i> Parcelamento
                  <span class="req">*</span></label
                >
                <select class="form-control" formControlName="installments">
                  <option *ngFor="let i of installmentsOptions" [ngValue]="i">
                    {{ i }}x
                  </option>
                </select>
              </div>
            </div>

            <hr class="my-4" />
            <h6>
              <i class="bi bi-card-list"></i> Parcelas (Gerado Automaticamente)
            </h6>

            <div formArrayName="installmentsArray">
              <div
                *ngFor="
                  let installment of installmentsArray.controls;
                  let i = index
                "
                [formGroupName]="i"
                class="row g-2 mb-2 installment-item align-items-center"
              >
                <div class="col-12 col-md-2">
                  <label class="form-label-sm"
                    ><strong>Parcela {{ i + 1 }}</strong></label
                  >
                </div>
                <div class="col-12 col-md-5">
                  <div class="input-group">
                    <span class="input-group-text">R$</span>
                    <input
                      type="number"
                      class="form-control"
                      formControlName="value"
                    />
                  </div>
                </div>
                <div class="col-12 col-md-5">
                  <div class="input-group">
                    <span class="input-group-text"
                      ><i class="bi bi-calendar"></i
                    ></span>
                    <input
                      type="date"
                      class="form-control"
                      formControlName="dueDate"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-4">
          <button
            type="button"
            class="btn btn-lg btn-outline-secondary"
            (click)="resetForm()"
          >
            Limpar Formulário
          </button>
          <button
            type="submit"
            class="btn btn-lg btn-primary"
            [disabled]="orderForm.invalid"
          >
            Salvar Ordem de Serviço
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

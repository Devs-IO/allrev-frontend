<div
  class="orders-detail container p-4 mx-auto max-w-5xl"
  *ngIf="order as o; else loadingTpl"
>
  <div class="row g-3 mb-3">
    <div class="col-12 col-xxl-8">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h1 class="h5 m-0">Ordem {{ o.orderNumber }}</h1>
            <div class="d-flex gap-2">
              <span class="badge bg-light text-dark">{{
                o.paymentStatus
              }}</span>
              <span class="badge bg-light text-dark">{{ o.workStatus }}</span>
            </div>
          </div>
          <div class="text-muted small">
            Cliente:
            <strong class="text-body">{{
              o.client.name || o.client.id
            }}</strong>
          </div>
          <div class="text-muted small">
            Contrato:
            <strong class="text-body">{{ toPtDate(o.contractDate) }}</strong>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-xxl-4">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fs-5">{{ formatPtBR(o.amountTotal) }}</div>
            <small class="text-muted">Total</small>
          </div>
          <div
            class="progress"
            role="progressbar"
            aria-label="Progresso de pagamento"
            [attr.aria-valuenow]="progressPct"
            aria-valuemin="0"
            aria-valuemax="100"
          >
            <div class="progress-bar" [style.width.%]="progressPct"></div>
          </div>
          <div class="small text-muted mt-1">
            {{ formatPtBR(o.amountPaid) }} de
            {{ formatPtBR(o.amountTotal) }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Parcelas</span>
      <button
        class="btn btn-sm btn-link"
        (click)="toggle('installments')"
        [attr.aria-expanded]="isOpen('installments')"
      >
        {{ isOpen("installments") ? "Ocultar" : "Mostrar" }}
      </button>
    </div>
    <div class="card-body" *ngIf="isOpen('installments')">
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>#</th>
              <th>Valor</th>
              <th>Vencimento</th>
              <th>Pago em</th>
              <th class="text-end">Ação</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let inst of o.installments; trackBy: trackByInst">
              <td>{{ inst.sequence }}</td>
              <td>{{ formatPtBR(inst.amount) }}</td>
              <td>{{ toPtDate(inst.dueDate) }}</td>
              <td>{{ inst.paidAt ? toPtDate(inst.paidAt) : "—" }}</td>
              <td class="text-end">
                <button
                  class="btn btn-sm btn-success"
                  aria-label="Marcar parcela como paga"
                  (click)="markPaid(inst)"
                  [disabled]="!!inst.paidAt || paying"
                >
                  Marcar paga
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Itens</span>
      <button
        class="btn btn-sm btn-link"
        (click)="toggle('items')"
        [attr.aria-expanded]="isOpen('items')"
      >
        {{ isOpen("items") ? "Ocultar" : "Mostrar" }}
      </button>
    </div>
    <div class="card-body" *ngIf="isOpen('items')">
      <div class="row g-3">
        <div
          class="col-12 col-md-6"
          *ngFor="let it of o.items; trackBy: trackByItem"
        >
          <div class="border rounded p-3 h-100">
            <div class="fw-semibold mb-1">
              {{ it.functionality.name || it.functionality.id }}
            </div>
            <div class="text-muted small mb-1">
              Preço:
              <strong class="text-body">{{ formatPtBR(it.price) }}</strong>
              • Prazo cliente:
              <strong class="text-body">{{
                toPtDate(it.clientDeadline)
              }}</strong>
            </div>
            <div class="mb-2">
              <span class="badge bg-light text-dark">{{ it.itemStatus }}</span>
            </div>
            <div class="small text-muted">
              <div>
                Responsável:
                <strong class="text-body">{{
                  (it.responsible && it.responsible.name) ||
                    (it.responsible && it.responsible.userId) ||
                    "—"
                }}</strong>
              </div>
              <div>
                Prazo assistente:
                <strong class="text-body">{{
                  it.responsible && it.responsible.assistantDeadline
                    ? toPtDate(it.responsible.assistantDeadline)
                    : "—"
                }}</strong>
              </div>
              <div>
                Valor assistente:
                <strong class="text-body">{{
                  it.responsible && it.responsible.amount != null
                    ? formatPtBR(it.responsible.amount)
                    : "—"
                }}</strong>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #loadingTpl>
  <div class="container p-4">Carregando…</div>
</ng-template>
